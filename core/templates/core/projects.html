{% extends 'core/base.html' %}
{% load static %}
{% load task_permissions %}

{% block breadcrumb %}
<li class="breadcrumb-item">Home</li>
<li class="breadcrumb-item">Tasks</li>
<li class="breadcrumb-item active">Views</li>
{% endblock breadcrumb%}

{% block content %}
<div class="col-md-12">
    <div class="card">
        <div class="card-header">
                            <div class="d-flex justify-content-between align-items-center">
                    <strong>
                        {% if is_my_tasks %}
                            {{ tasks_qs.count }} My Tasks
                        {% else %}
                            {{ tasks_qs.count }} Tasks of Overall Sections
                        {% endif %}
                    </strong>
                    <div class="btn-group" role="group">
                        {% if user.user_type != 'admin' %}
                            <a href="{% url 'core:new-task' %}" class="btn btn-primary btn-sm">
                                <i class="fa fa-plus"></i> New Task
                            </a>
                        {% endif %}
                        {% if user.user_type == 'admin' %}
                            <a href="{% url 'core:users' %}" class="btn btn-info btn-sm">
                                <i class="fa fa-users"></i> Manage Users
                            </a>
                        {% endif %}
                    </div>
                </div>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-sm-8">
                    <div class="row">
                        <div class="col-sm-6">
                            <div class="callout callout-dark">
                                <small class="text-muted">Tasks</small>
                                <br>
                                <strong class="h4">{{ tasks_qs.count }}</strong>
                                <div class="chart-wrapper">
                                    <canvas id="sparkline-chart-3" width="86" height="25"></canvas>
                                </div>
                            </div>
                        </div>
                        <div class="col-sm-6">
                            <div class="callout callout-info">
                                <small class="text-muted">Average Completion</small>
                                <br>
                                <strong class="h4">{{ avg_tasks|floatformat:1 }}%</strong>
                                <div class="chart-wrapper">
                                    <canvas id="sparkline-chart-4" width="86" height="25"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="col-sm-4">
                    <ul class="list-group list-group-flush">
                        <li>
                            <i class="fa fa-percent"></i>
                            <span class="title">Tasks</span>
                            <span class="value">{{ avg_tasks|floatformat:1 }}%</span>
                            <div class="bars">
                                <div class="progress progress-xs">
                                    <div class="progress-bar bg-warning" role="progressbar" 
                                         aria-valuenow="{{ avg_tasks|floatformat:0 }}" 
                                         aria-valuemin="0" aria-valuemax="100"
                                         data-width="{{ avg_tasks|floatformat:0 }}"></div>
                                </div>
                            </div>
                        </li>
                        <li class="divider"></li>
                        {% for task in tasks %}
                        <li class="my-2">
                            {% if task.status == 'open' %}
                                <span class="badge badge-primary" style="width: 50px;">Open</span>
                            {% elif task.status == 'closed' %}
                                <span class="badge badge-success" style="width: 50px;">Closed</span>
                            {% else %}
                                <span class="badge badge-warning" style="width: 50px;">Due</span>
                            {% endif %}
                            <span class="title ml-1" data-i18n-skip>{{ task.issue_action|truncatechars:30 }}</span>
                            <span class="value"> 
                                <span class="text-muted small">close: </span>{{ task.close_date }}
                                <span class="text-muted small">({{ task.percentage_completion }}%)</span>
                            </span>
                            <div class="bars">
                                <div class="progress progress-xs">
                                    <div class="progress-bar bg-success" role="progressbar" 
                                         aria-valuenow="{{ task.percentage_completion }}" 
                                         aria-valuemin="0" aria-valuemax="100"
                                         data-width="{{ task.percentage_completion }}"></div>
                                </div>
                            </div>
                        </li>
                        {% endfor %}
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="col-md-12">
    <div class="card">
        <div class="card-header">
            <strong>Task Details</strong>
        </div>
        <div class="card-body">
            <form method="get" class="form-row align-items-end mb-3">
                {% if not is_my_tasks %}
                <div class="col-md-2 mb-2">
                    <input type="text" name="employee" class="form-control" placeholder="Employee name..." value="{{ employee_query }}">
                </div>
                {% endif %}
                <div class="col-md-3 mb-2">
                    <input type="text" name="search" class="form-control" placeholder="Search by task name..." value="{{ search_query }}">
                </div>
                <div class="col-md-2 mb-2">
                    <select name="status" class="form-control">
                        <option value="">All Statuses</option>
                        <option value="open" {% if status_filter == 'open' %}selected{% endif %}>Open</option>
                        <option value="closed" {% if status_filter == 'closed' %}selected{% endif %}>Closed</option>
                        <option value="due" {% if status_filter == 'due' %}selected{% endif %}>Due</option>
                    </select>
                </div>
                <div class="col-md-2 mb-2">
                    <input type="date" name="start_date" class="form-control" placeholder="Start Date" value="{{ start_date }}">
                </div>
                <div class="col-md-2 mb-2">
                    <input type="date" name="end_date" class="form-control" placeholder="End Date" value="{{ end_date }}">
                </div>
                <div class="col-md-2 mb-2">
                    <button type="submit" class="btn btn-primary w-100"><i class="fa fa-search"></i> Filter</button>
                </div>
            </form>
            <div class="table-responsive table-responsive-sm">
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th class="text-nowrap" style="min-width:140px;">Issue/Action</th>
                            <th class="text-nowrap" style="min-width:110px;">Responsible</th>
                            <th class="text-nowrap d-none d-sm-table-cell" style="min-width:90px;">Priority</th>
                            <th class="text-nowrap d-none d-md-table-cell" style="min-width:90px;">KPI</th>
                            <th class="text-nowrap" style="min-width:90px;">Status</th>
                            <th class="text-nowrap" style="min-width:110px;">Completion</th>
                            <th class="text-nowrap d-none d-md-table-cell" style="min-width:110px;">Close Date</th>
                            <th class="text-nowrap" style="min-width:110px;">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for task in tasks %}
                        <tr>
                            <td class="text-nowrap" style="min-width:140px;">
                                <a href="{% url 'core:task-detail' task.id %}" target="_blank" rel="noopener noreferrer" class="text-dark" style="text-decoration: none;">
                                    <strong data-i18n-skip>{{ task.issue_action|truncatechars:40 }}</strong>
                                    {% if task.is_overdue %}
                                        <span class="badge badge-danger ml-1">Overdue</span>
                                    {% endif %}
                                </a>
                            </td>
                            <td class="text-nowrap" style="min-width:110px;" data-i18n-skip>{{ task.responsible.get_full_name }}</td>
                            <td class="text-nowrap d-none d-sm-table-cell" style="min-width:90px;" data-i18n-skip>
                                {% if task.priority %}
                                    <span class="badge badge-{% if task.priority.code == 'high' %}danger{% elif task.priority.code == 'medium' %}warning{% else %}info{% endif %}">
                                        {{ task.priority.name }}
                                    </span>
                                {% else %}
                                    <span class="badge badge-secondary">-</span>
                                {% endif %}
                            </td>
                            <td class="text-nowrap d-none d-md-table-cell" style="min-width:90px;" data-i18n-skip>{% if task.kpi %}{{ task.kpi.name }}{% else %}-{% endif %}</td>
                            <td class="text-nowrap" style="min-width:90px;">
                                <span class="badge badge-{% if task.status == 'open' %}primary{% elif task.status == 'closed' %}success{% else %}warning{% endif %}">
                                    {{ task.get_status_display }}
                                </span>
                            </td>
                            <td class="text-nowrap" style="min-width:110px;">
                                <div class="progress" style="height: 20px; min-width: 80px;">
                                    <div class="progress-bar" role="progressbar" 
                                         data-width="{{ task.percentage_completion }}"
                                         aria-valuenow="{{ task.percentage_completion }}" 
                                         aria-valuemin="0" aria-valuemax="100">
                                        {{ task.percentage_completion }}%
                                    </div>
                                </div>
                            </td>
                            <td class="text-nowrap d-none d-md-table-cell" style="min-width:110px;">{{ task.close_date }}</td>
                            <td class="text-nowrap" style="min-width:110px;">
                                <div class="btn-group" role="group">
                                    <a href="{% url 'core:task-detail' task.id %}" class="btn btn-sm btn-outline-primary" target="_blank" rel="noopener noreferrer">
                                        <i class="fa fa-eye"></i>
                                    </a>
                                    {% if task|can_user_edit:user %}
                                        <a href="{% url 'core:edit-task' task.id %}" class="btn btn-sm btn-outline-warning">
                                            <i class="fa fa-edit"></i>
                                        </a>
                                        <a href="{% url 'core:delete-task' task.id %}" class="btn btn-sm btn-outline-danger">
                                            <i class="fa fa-trash"></i>
                                        </a>
                                    {% endif %}
                                    {% if task.file_upload and task|can_user_download_file:user %}
                                        <a href="{% url 'core:download-file' task.id %}" class="btn btn-sm btn-outline-info">
                                            <i class="fa fa-download"></i>
                                        </a>
                                    {% endif %}
                                    {% if task|can_user_upload_file:user %}
                                        <a href="{% url 'core:task-detail' task.id %}" class="btn btn-sm btn-outline-success" target="_blank" rel="noopener noreferrer">
                                            <i class="fa fa-upload"></i>
                                        </a>
                                    {% endif %}
                                    <button type="button" class="btn btn-sm {% if task.has_reminder %}btn-success{% else %}btn-outline-secondary{% endif %}" data-toggle="modal" data-target="#reminderModal-{{ task.id }}" title="Schedule reminder">
                                        <i class="fa fa-bell"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                        <!-- Reminder Modal -->
                        <div class="modal fade" id="reminderModal-{{ task.id }}" tabindex="-1" role="dialog" aria-labelledby="reminderLabel-{{ task.id }}" aria-hidden="true">
                          <div class="modal-dialog modal-dialog-centered" role="document">
                            <div class="modal-content">
                              <div class="modal-header">
                                <h5 class="modal-title" id="reminderLabel-{{ task.id }}">Schedule Email Reminder</h5>
                                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                  <span aria-hidden="true">&times;</span>
                                </button>
                              </div>
                              <form method="post" action="{% url 'core:create-task-reminder' task.id %}">
                                {% csrf_token %}
                                <div class="modal-body">
                                  <div class="form-group">
                                    <label for="reminder-date-{{ task.id }}">Reminder Date</label>
                                    <input id="reminder-date-{{ task.id }}" name="scheduled_for" type="date" class="form-control" required>
                                  </div>
                                  <div class="form-group mb-0">
                                    <label for="reminder-message-{{ task.id }}">Message (optional)</label>
                                    <textarea id="reminder-message-{{ task.id }}" name="message" class="form-control" rows="3" placeholder="Optional message"></textarea>
                                  </div>
                                </div>
                                <div class="modal-footer">
                                  <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                                  <button type="submit" class="btn btn-primary">Save Reminder</button>
                                </div>
                              </form>
                            </div>
                          </div>
                        </div>
                        {% empty %}
                        <tr>
                            <td colspan="8" class="text-center text-muted">
                                No tasks found.
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<div class="col-md-12">
    <div class="card">
        <div class="card-header">
            <strong>Task Cards View</strong>
        </div>
        <div class="card-body">
            <div class="row">
                {% for task in tasks %}
                <div class="col-12 col-md-6">
                    <div class="card mx-2 mb-3">
                        <div class="card-body">
                            <a href="{% url 'core:task-detail' task.id %}" target="_blank" rel="noopener noreferrer" class="text-dark" style="text-decoration: none;">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <h6 class="card-title" data-i18n-skip>{{ task.issue_action|truncatechars:50 }}</h6>
                                <span class="badge badge-{% if task.status == 'open' %}primary{% elif task.status == 'closed' %}success{% else %}warning{% endif %}" data-i18n-skip>
                                    {{ task.get_status_display }}
                                </span>
                            </div>
                        </a>
                            
                            <p class="card-text">
                                <small class="text-muted">
                                    <strong>Responsible:</strong> <div data-i18n-skip>{{ task.responsible.get_full_name }}</div><br>
                                    <strong>Priority:</strong> 
                                    {% if task.priority %}
                                        <span class="badge badge-{% if task.priority.code == 'high' %}danger{% elif task.priority.code == 'medium' %}warning{% else %}info{% endif %}" data-i18n-skip>
                                            {{ task.priority.name }}
                                        </span>
                                    {% else %}
                                        <span class="badge badge-secondary" data-i18n-skip>-</span>
                                    {% endif %}<br>
                                    <strong>KPI:</strong> {% if task.kpi %}{{ task.kpi.name }}{% else %}-{% endif %}<br>
                                    <strong>Close Date:</strong> {{ task.close_date }}
                                </small>
                            </p>
                            
                            <div class="mb-2">
                                <small class="text-muted">Completion: {{ task.percentage_completion }}%</small>
                                <div class="progress" style="height: 8px;">
                                    <div class="progress-bar" role="progressbar" 
                                         data-width="{{ task.percentage_completion }}"
                                         aria-valuenow="{{ task.percentage_completion }}" 
                                         aria-valuemin="0" aria-valuemax="100"></div>
                                </div>
                            </div>
                            
                            <div class="btn-group btn-group-sm" role="group">
                                <a href="{% url 'core:task-detail' task.id %}" class="btn btn-outline-primary" target="_blank" rel="noopener noreferrer">
                                    <i class="fa fa-eye"></i> View
                                </a>
                                {% if task|can_user_edit:user %}
                                    <a href="{% url 'core:edit-task' task.id %}" class="btn btn-outline-warning">
                                        <i class="fa fa-edit"></i> Edit
                                    </a>
                                {% endif %}
                                {% if task.file_upload and task|can_user_download_file:user %}
                                    <a href="{% url 'core:download-file' task.id %}" class="btn btn-outline-info">
                                        <i class="fa fa-download"></i> Download
                                    </a>
                                {% endif %}
                                {% if task|can_user_upload_file:user %}
                                    <a href="{% url 'core:upload-task-file' task.id %}" class="btn btn-outline-success">
                                        <i class="fa fa-upload"></i> Upload
                                    </a>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
                {% empty %}
                <div class="col-12">
                    <div class="text-center text-muted">
                        <i class="fa fa-tasks fa-3x mb-3"></i>
                        <p>No tasks found.</p>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>

<!-- Pagination Controls -->
{% if tasks.has_other_pages %}
<div class="col-md-12">
    <div class="card">
        <div class="card-body">
            <nav aria-label="Task pagination">
                <ul class="pagination justify-content-center mb-0">
                    {% if tasks.has_previous %}
                        <li class="page-item">
                            <a class="page-link" href="?page=1{% if request.GET %}&{% for key, value in request.GET.items %}{% if key != 'page' %}{{ key }}={{ value }}{% if not forloop.last %}&{% endif %}{% endif %}{% endfor %}{% endif %}" aria-label="First">
                                <span aria-hidden="true">&laquo;&laquo;</span>
                            </a>
                        </li>
                        <li class="page-item">
                            <a class="page-link" href="?page={{ tasks.previous_page_number }}{% if request.GET %}&{% for key, value in request.GET.items %}{% if key != 'page' %}{{ key }}={{ value }}{% if not forloop.last %}&{% endif %}{% endif %}{% endfor %}{% endif %}" aria-label="Previous">
                                <span aria-hidden="true">&laquo;</span>
                            </a>
                        </li>
                    {% else %}
                        <li class="page-item disabled">
                            <span class="page-link">&laquo;&laquo;</span>
                        </li>
                        <li class="page-item disabled">
                            <span class="page-link">&laquo;</span>
                        </li>
                    {% endif %}

                    {% for num in tasks.paginator.page_range %}
                        {% if tasks.number == num %}
                            <li class="page-item active">
                                <span class="page-link">{{ num }}</span>
                            </li>
                        {% elif num > tasks.number|add:'-3' and num < tasks.number|add:'3' %}
                            <li class="page-item">
                                <a class="page-link" href="?page={{ num }}{% if request.GET %}&{% for key, value in request.GET.items %}{% if key != 'page' %}{{ key }}={{ value }}{% if not forloop.last %}&{% endif %}{% endif %}{% endfor %}{% endif %}">{{ num }}</a>
                            </li>
                        {% endif %}
                    {% endfor %}

                    {% if tasks.has_next %}
                        <li class="page-item">
                            <a class="page-link" href="?page={{ tasks.next_page_number }}{% if request.GET %}&{% for key, value in request.GET.items %}{% if key != 'page' %}{{ key }}={{ value }}{% if not forloop.last %}&{% endif %}{% endif %}{% endfor %}{% endif %}" aria-label="Next">
                                <span aria-hidden="true">&raquo;</span>
                            </a>
                        </li>
                        <li class="page-item">
                            <a class="page-link" href="?page={{ tasks.paginator.num_pages }}{% if request.GET %}&{% for key, value in request.GET.items %}{% if key != 'page' %}{{ key }}={{ value }}{% if not forloop.last %}&{% endif %}{% endif %}{% endfor %}{% endif %}" aria-label="Last">
                                <span aria-hidden="true">&raquo;&raquo;</span>
                            </a>
                        </li>
                    {% else %}
                        <li class="page-item disabled">
                            <span class="page-link">&raquo;</span>
                        </li>
                        <li class="page-item disabled">
                            <span class="page-link">&raquo;&raquo;</span>
                        </li>
                    {% endif %}
                </ul>
            </nav>
            <div class="text-center mt-2">
                <small class="text-muted">
                    Page {{ tasks.number }} of {{ tasks.paginator.num_pages }} 
                    ({{ tasks.paginator.count }} total tasks)
                </small>
            </div>
        </div>
    </div>
</div>
{% endif %}

{% endblock %}

<script>
// Apply progress bar widths from data attributes
document.addEventListener('DOMContentLoaded', function() {
    const progressBars = document.querySelectorAll('.progress-bar[data-width]');
    progressBars.forEach(function(bar) {
        const width = bar.getAttribute('data-width');
        bar.style.width = width + '%';
    });
});
</script>