{% extends 'core/base.html' %}
{% load static %}

{% block breadcrumb %}
    <li class="breadcrumb-item">Settings</li>
    <li class="breadcrumb-item active">Progress Report</li>
{% endblock breadcrumb %}

{% block content %}
<div class="container">
  <div class="row">
    <div class="col-12 col-lg-10 offset-lg-1">
      <div class="card shadow-sm mb-4">
        <div class="card-header d-flex justify-content-between align-items-center bg-primary text-white">
          <strong><i class="fa fa-file-excel-o mr-2"></i>Progress Report</strong>
        </div>
        <div class="card-body">
          <form method="get" class="row g-2 align-items-end mb-4">
            <div class="col-md-3 col-12">
              <label for="employee">Employee:</label>
              <select name="employee" id="employee" class="form-control">
                <option value="">-- Select Employee --</option>
                {% for emp in subordinates %}
                  <option value="{{ emp.id }}" {% if emp.id|stringformat:'s' == selected_employee.id|stringformat:'s' %}selected{% endif %}>{{ emp.get_full_name }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="col-md-3 col-12">
              <label for="start_date">Start Date:</label>
              <input type="date" name="start_date" id="start_date" class="form-control" value="{{ start_date|date:'Y-m-d' }}">
            </div>
            <div class="col-md-3 col-12">
              <label for="end_date">End Date:</label>
              <input type="date" name="end_date" id="end_date" class="form-control" value="{{ end_date|date:'Y-m-d' }}">
            </div>
            <div class="col-md-3 col-12">
              <label for="status">Status:</label>
              <select name="status" id="status" class="form-control">
                <option value="">All</option>
                <option value="open" {% if status_filter == 'open' %}selected{% endif %}>Open</option>
                <option value="closed" {% if status_filter == 'closed' %}selected{% endif %}>Closed</option>
                <option value="due" {% if status_filter == 'due' %}selected{% endif %}>Due</option>
              </select>
            </div>
            <div class="col-md-3 col-12">
              <label for="priority">Priority:</label>
              <select name="priority" id="priority" class="form-control">
                <option value="">All</option>
                {% for priority in available_priorities %}
                  <option value="{{ priority.id }}" {% if priority.id|stringformat:'s' == priority_filter|stringformat:'s' %}selected{% endif %}>{{ priority.name }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="col-md-3 col-12 mt-2 mt-md-0">
              <label for="kpi">KPI:</label>
              <select name="kpi" id="kpi" class="form-control">
                <option value="">All</option>
                {% for kpi in available_kpis %}
                  <option value="{{ kpi.id }}" {% if kpi.id|stringformat:'s' == kpi_filter|stringformat:'s' %}selected{% endif %}>{{ kpi.name }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="col-md-4 col-12 mt-2 mt-md-0">
              <label for="search">Search:</label>
              <input type="text" name="search" id="search" class="form-control" placeholder="Task name/description..." value="{{ search_query }}">
            </div>
            <div class="col-md-2 col-12 mt-2 mt-md-0">
              <button type="submit" class="btn btn-primary w-100"><i class="fa fa-search"></i> Filter</button>
            </div>
          </form>

          {% if tasks and tasks|length > 0 %}
            {% if employee_progress_score is not None %}
            <div class="alert alert-info mb-3">
              <strong>Employee Progress Score:</strong> {{ employee_progress_score }}%
              {% if progress_period_label %}
                <span class="ml-2 text-muted">({{ progress_period_label }})</span>
              {% endif %}
            </div>
            {% endif %}
            <div class="mb-3 d-flex flex-wrap gap-2">
              <a href="?employee={{ selected_employee.id }}&start_date={{ start_date }}&end_date={{ end_date }}&status={{ status_filter }}&priority={{ priority_filter }}&kpi={{ kpi_filter }}&search={{ search_query }}&export=excel" class="btn btn-success btn-sm mr-2"><i class="fa fa-file-excel-o"></i> Download Excel</a>
              <a href="?employee={{ selected_employee.id }}&start_date={{ start_date }}&end_date={{ end_date }}&status={{ status_filter }}&priority={{ priority_filter }}&kpi={{ kpi_filter }}&search={{ search_query }}&export=pdf" class="btn btn-danger btn-sm"><i class="fa fa-file-pdf-o"></i> Download PDF</a>
            </div>
            <div class="table-responsive table-responsive-sm">
              <table class="table table-striped table-bordered align-middle">
                <thead class="thead-light">
                  <tr>
                    <th class="text-nowrap" style="min-width:180px;">Task</th>
                    <th class="text-nowrap" style="min-width:100px;">Status</th>
                    <th class="text-nowrap d-none d-sm-table-cell" style="min-width:100px;">KPI</th>
                    <th class="text-nowrap d-none d-md-table-cell" style="min-width:90px;">Priority</th>
                    <th class="text-nowrap" style="min-width:110px;">Start Date</th>
                    <th class="text-nowrap d-none d-md-table-cell" style="min-width:110px;">Close Date</th>
                    <th class="text-nowrap" style="min-width:120px;">Completion</th>
                  </tr>
                </thead>
                <tbody>
                  {% for task in tasks %}
                    <tr>
                      <td class="text-wrap" style="max-width: 250px; min-width:180px;">
                        <span title="{{ task.issue_action }}">{{ task.issue_action|truncatechars:60 }}</span>
                      </td>
                      <td class="text-nowrap" style="min-width:100px;">
                        <span class="badge badge-{% if task.status == 'open' %}primary{% elif task.status == 'closed' %}success{% else %}warning{% endif %}">
                          {{ task.get_status_display }}
                        </span>
                      </td>
                      <td class="text-nowrap d-none d-sm-table-cell" style="min-width:100px;">{% if task.kpi %}{{ task.kpi.name }}{% else %}-{% endif %}</td>
                      <td class="text-nowrap d-none d-md-table-cell" style="min-width:90px;">
                        {% if task.priority %}
                          <span class="badge badge-{% if task.priority.code == 'high' %}danger{% elif task.priority.code == 'medium' %}warning{% else %}info{% endif %}">
                            {{ task.priority.name }}
                          </span>
                        {% else %}
                          <span class="badge badge-secondary">-</span>
                        {% endif %}
                      </td>
                      <td class="text-nowrap" style="min-width:110px;">{{ task.start_date }}</td>
                      <td class="text-nowrap d-none d-md-table-cell" style="min-width:110px;">{{ task.close_date }}</td>
                      <td class="text-nowrap" style="min-width:120px;">
                        <div class="progress" style="height: 18px; min-width: 80px;">
                          <div class="progress-bar bg-success" role="progressbar"
                               data-width="{{ task.percentage_completion|default:0 }}"
                               aria-valuenow="{{ task.percentage_completion|default:0 }}"
                               aria-valuemin="0" aria-valuemax="100">
                            {{ task.percentage_completion|default:0 }}%
                          </div>
                        </div>
                      </td>
                    </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
            {% if is_paginated %}
              <nav aria-label="Progress Report pagination">
                <ul class="pagination justify-content-center">
                  {% if page_obj.has_previous %}
                    <li class="page-item">
                      <a class="page-link" href="?{{ base_query }}&page=1">First</a>
                    </li>
                    <li class="page-item">
                      <a class="page-link" href="?{{ base_query }}&page={{ page_obj.previous_page_number }}">Previous</a>
                    </li>
                  {% endif %}
                  <li class="page-item active">
                    <span class="page-link">
                      Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}
                    </span>
                  </li>
                  {% if page_obj.has_next %}
                    <li class="page-item">
                      <a class="page-link" href="?{{ base_query }}&page={{ page_obj.next_page_number }}">Next</a>
                    </li>
                    <li class="page-item">
                      <a class="page-link" href="?{{ base_query }}&page={{ page_obj.paginator.num_pages }}">Last</a>
                    </li>
                  {% endif %}
                </ul>
              </nav>
            {% endif %}
          {% elif selected_employee %}
            <div class="alert alert-info mt-4">No tasks found for the selected filters.</div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %} 