{% extends 'core/base.html' %}
{% load static %}

{% block breadcrumb %}
  <li class="breadcrumb-item">Settings</li>
  <li class="breadcrumb-item active">Monthly Employee Statistics</li>
{% endblock breadcrumb %}

{% block content %}
<div class="container monthly-stats-section">
  <div class="card mb-3">
    <div class="card-body">
      <form class="row g-2" method="get">
        <div class="col-md-4">
          <label class="form-label">Employee (name/email/username)</label>
          <input type="text" class="form-control" name="employee" value="{{ filter_employee_query|default:'' }}" placeholder="Search employee" />
        </div>
        <div class="col-md-3">
          <label class="form-label">Month</label>
          <input type="month" class="form-control" name="month" value="{{ filter_month|default:'' }}" />
        </div>
        <div class="col-md-3">
          <label class="form-label">Or Up To Date</label>
          <select class="form-select form-control" name="upto">
            <option value="">Current month only</option>
            <option value="ytd" {% if filter_upto == 'ytd' %}selected{% endif %}>Since start of year</option>
          </select>
        </div>
        <div class="col-md-2 d-flex align-items-end">
          <button type="submit" class="btn btn-primary w-100"><i class="fa fa-search"></i> Filter</button>
        </div>
      </form>
      <div class="text-muted mt-2">
        Period: {{ start_date }} — {{ end_date }}
      </div>
    </div>
  </div>

  <div class="card">
    <div class="card-body table-responsive">
      <div class="mb-3 d-flex flex-wrap gap-2">
        <a href="?employee={{ filter_employee_query }}&month={{ filter_month }}&upto={{ filter_upto }}&export=excel" class="btn btn-success btn-sm mr-2"><i class="fa fa-file-excel-o"></i> Download Excel</a>
        <a href="?employee={{ filter_employee_query }}&month={{ filter_month }}&upto={{ filter_upto }}&export=pdf" class="btn btn-danger btn-sm"><i class="fa fa-file-pdf-o"></i> Download PDF</a>
      </div>

     
      <table class="table table-striped table-hover align-middle">
        <thead>
          <tr>
            <th>Employee</th>
            <th>Total Assigned</th>
            <th>Completed</th>
            <th>Open</th>
            <th>Closed</th>
            <th>Due</th>
            <th>Completion Rate</th>
            <th>High</th>
            <th>Medium</th>
            <th>Low</th>
            <th>Timeliness (avg days vs target)</th>
          </tr>
        </thead>
        <tbody>
        {% for row in stats %}
          <tr>
            <td>{{ row.employee.get_full_name|default:row.employee.username }}</td>
            <td>{{ row.total_assigned }}</td>
            <td>{{ row.total_completed }}</td>
            <td>{{ row.open_count }}</td>
            <td>{{ row.closed_count }}</td>
            <td>{{ row.due_count }}</td>
            <td>{{ row.completion_rate }}%</td>
            <td>{{ row.priority_high }}</td>
            <td>{{ row.priority_medium }}</td>
            <td>{{ row.priority_low }}</td>
            <td>
              {% if row.avg_timeliness_days is not None %}
                {% if row.avg_timeliness_days > 0 %}+{% endif %}{{ row.avg_timeliness_days }} days
              {% else %}
                —
              {% endif %}
            </td>
          </tr>
        {% empty %}
          <tr>
            <td colspan="11" class="text-center text-muted">No employees/tasks found for the selected period.</td>
          </tr>
        {% endfor %}
        </tbody>
      </table>
      <div class="col-12">
        <div class="card text-white bg-warning monthly-stats-card">
          <div class="card-body pb-0">
            <h4 class="mb-0">{{ open_tasks|default:0 }}</h4>
            <p>Total Tasks</p>
          </div>
          <div class="chart-wrapper" style="height:70px;">
            <canvas id="card-chart3" class="chart chartjs-render-monitor" height="70" width="280" style="display: block; width: 280px; height: 70px;"></canvas>
          </div>
        </div>
      </div>
  
      <div class="col-12">
        <div class="card text-white bg-danger monthly-stats-card">
          <div class="card-body pb-0">
            <h4 class="mb-0">{{ due_tasks|default:0 }}</h4>
            <p> Total Closed Tasks</p>
          </div>
          <div class="chart-wrapper px-3" style="height:70px;">
            <canvas id="card-chart4" class="chart chartjs-render-monitor" height="70" width="248" style="display: block; width: 248px; height: 70px;"></canvas>
          </div>
        </div>
      </div>
      {% if aggregate_open or aggregate_closed or aggregate_due %}
      <div class="row mb-4">
        <div class="col-md-6 mb-3">
          <div id="apex-monthlyStatus"></div>
        </div>
        <div class="col-md-6 mb-3">
          <div id="apex-priority"></div>
        </div>
      </div>
      {% if stats %}
      <div class="row mb-4">
        <div class="col-12">
          <div id="apex-employeeStatus"></div>
        </div>
      </div>
      <div class="row mb-4">
        <div class="col-12">
          <div id="apex-monthlyTrend"></div>
        </div>
      </div>
      {% endif %}
      {% endif %}
    </div>
  </div>
</div>

{% if aggregate_open or aggregate_closed or aggregate_due %}
  {# Inline JSON payloads for the charts (read by monthly_employee_stats.js) #}
  <script type="application/json" id="monthly-status-data">{{ chart_data_json|safe }}</script>
  <script type="application/json" id="priority-data">{{ priority_chart_json|safe }}</script>
  <script type="application/json" id="employee-status-data">{{ employee_status_chart_json|safe }}</script>
  <script type="application/json" id="monthly-trend-data">{{ monthly_trend_chart_json|safe }}</script>
  <div id="monthly-totals" data-total="{{ total_tasks|default:0 }}" data-closed="{{ closed_tasks|default:0 }}" hidden></div>
  <link rel="stylesheet" href="{% static 'core/css/monthly_employee_stats.css' %}">
  <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
  <script src="{% static 'core/js/monthly_employee_stats.js' %}"></script>
{% endif %}
{% endblock %}


